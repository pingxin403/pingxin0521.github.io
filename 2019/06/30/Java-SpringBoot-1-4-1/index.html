<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Spring boot æ•°æ®è®¿é—® Rediså’Œç¼“å­˜ | å¹³å¿ƒdeå°å±‹</title><meta name="keywords" content="Java,æ¡†æ¶"><meta name="author" content="å¹³å¿ƒ"><meta name="copyright" content="å¹³å¿ƒ"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="åœ¨ Spring çš„ç”Ÿæ€ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Spring Data Redis æ¥å®ç°å¯¹ Redis çš„æ•°æ®è®¿é—®ã€‚ å¯èƒ½è¿™ä¸ªæ—¶å€™ï¼Œä¼šæœ‰èƒ–å‹ä¼šæœ‰ç–‘æƒ‘ï¼Œå¸‚é¢ä¸Šå·²ç»æœ‰ Redisã€Redissonã€Lettuce ç­‰ä¼˜ç§€çš„ Java Redis å·¥å…·åº“ï¼Œä¸ºä»€ä¹ˆè¿˜è¦æœ‰ Spring Data Redis å‘¢ï¼Ÿå­¦ä¸åŠ¨äº†ï¼Œå¤´éƒ½è¦ç§ƒäº†ï¼ä¸è¦æ…Œï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€å¼ å›¾ï¼š   å¯¹äºä¸‹å±‚ï¼ŒSpring Data Redis æä¾›">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring boot æ•°æ®è®¿é—® Rediså’Œç¼“å­˜">
<meta property="og:url" content="https://pingxin0521.gitee.io/2019/06/30/Java-SpringBoot-1-4-1/index.html">
<meta property="og:site_name" content="å¹³å¿ƒdeå°å±‹">
<meta property="og:description" content="åœ¨ Spring çš„ç”Ÿæ€ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Spring Data Redis æ¥å®ç°å¯¹ Redis çš„æ•°æ®è®¿é—®ã€‚ å¯èƒ½è¿™ä¸ªæ—¶å€™ï¼Œä¼šæœ‰èƒ–å‹ä¼šæœ‰ç–‘æƒ‘ï¼Œå¸‚é¢ä¸Šå·²ç»æœ‰ Redisã€Redissonã€Lettuce ç­‰ä¼˜ç§€çš„ Java Redis å·¥å…·åº“ï¼Œä¸ºä»€ä¹ˆè¿˜è¦æœ‰ Spring Data Redis å‘¢ï¼Ÿå­¦ä¸åŠ¨äº†ï¼Œå¤´éƒ½è¦ç§ƒäº†ï¼ä¸è¦æ…Œï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€å¼ å›¾ï¼š   å¯¹äºä¸‹å±‚ï¼ŒSpring Data Redis æä¾›">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg">
<meta property="article:published_time" content="2019-06-30T11:19:59.000Z">
<meta property="article:modified_time" content="2020-01-23T08:12:42.950Z">
<meta property="article:author" content="å¹³å¿ƒ">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="æ¡†æ¶">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg"><link rel="shortcut icon" href="https://s2.ax1x.com/2020/02/11/1ovFOA.png"><link rel="canonical" href="https://pingxin0521.gitee.io/2019/06/30/Java-SpringBoot-1-4-1/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring boot æ•°æ®è®¿é—® Rediså’Œç¼“å­˜',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-01-23 16:12:42'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/02/11/1ovw6J.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">449</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">77</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">68</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">å¹³å¿ƒdeå°å±‹</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> å…³äº</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Spring boot æ•°æ®è®¿é—® Rediså’Œç¼“å­˜</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2019-06-30T11:19:59.000Z" title="å‘è¡¨äº 2019-06-30 19:19:59">2019-06-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2020-01-23T08:12:42.950Z" title="æ›´æ–°äº 2020-01-23 16:12:42">2020-01-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/Spring-boot/">Spring boot</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">6.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>28åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Spring boot æ•°æ®è®¿é—® Rediså’Œç¼“å­˜"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>åœ¨ Spring çš„ç”Ÿæ€ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://spring.io/projects/spring-data-redis">Spring Data Redis</a> æ¥å®ç°å¯¹ Redis çš„æ•°æ®è®¿é—®ã€‚</p>
<p>å¯èƒ½è¿™ä¸ªæ—¶å€™ï¼Œä¼šæœ‰èƒ–å‹ä¼šæœ‰ç–‘æƒ‘ï¼Œå¸‚é¢ä¸Šå·²ç»æœ‰ Redisã€Redissonã€Lettuce ç­‰ä¼˜ç§€çš„ Java Redis å·¥å…·åº“ï¼Œä¸ºä»€ä¹ˆè¿˜è¦æœ‰ Spring Data Redis å‘¢ï¼Ÿå­¦ä¸åŠ¨äº†ï¼Œå¤´éƒ½è¦ç§ƒäº†ï¼ä¸è¦æ…Œï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€å¼ å›¾ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2019/12/22/QzsSWq.png" alt="QzsSWq.png"></p>
<ul>
<li>å¯¹äºä¸‹å±‚ï¼ŒSpring Data Redis æä¾›äº†ç»Ÿä¸€çš„æ“ä½œæ¨¡æ¿ï¼ˆåæ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æ˜¯ RedisTemplate ç±»ï¼‰ï¼Œå°è£…äº† Jedisã€Lettuce çš„ API æ“ä½œï¼Œè®¿é—® Redis æ•°æ®ã€‚æ‰€ä»¥ï¼Œ<strong>å®é™…ä¸Šï¼ŒSpring Data Redis å†…ç½®çœŸæ­£è®¿é—®çš„å®é™…æ˜¯ Jedisã€Lettuce ç­‰ API æ“ä½œ</strong>ã€‚</li>
<li>å¯¹äºä¸Šå±‚ï¼Œå¼€å‘è€…å­¦ä¹ å¦‚ä½•ä½¿ç”¨ Spring Data Redis å³å¯ï¼Œè€Œæ— éœ€å…³å¿ƒ Jedisã€Lettuce çš„ API æ“ä½œã€‚ç”šè‡³ï¼Œæœªæ¥å¦‚æœæˆ‘ä»¬æƒ³å°† Redis è®¿é—®ä» Jedis è¿ç§»æˆ Lettuce æ¥ï¼Œæ— éœ€åšä»»ä½•çš„å˜åŠ¨ã€‚ğŸ˜ˆ ç›¸ä¿¡å¾ˆå¤šèƒ–å‹ï¼Œåœ¨é€‰æ‹© Java Redis å·¥å…·åº“ï¼Œä¹Ÿæ˜¯æœ‰è¿‡çƒ¦æ¼çš„ã€‚</li>
<li>ç›®å‰ï¼ŒSpring Data Redis æš‚æ—¶åªæ”¯æŒ Jedisã€Lettuce çš„å†…éƒ¨å°è£…ï¼Œè€Œ Redisson æ˜¯ç”± <a target="_blank" rel="noopener" href="https://github.com/redisson/redisson/tree/master/redisson-spring-data">redisson-spring-data</a> æ¥æä¾›ã€‚</li>
</ul>
<p>Spring Data Redisé»˜è®¤ä½¿ç”¨Lettuceæ¡†æ¶</p>
<p>Lettuce æ˜¯ä¸€ä¸ªå¯ä¼¸ç¼©çº¿ç¨‹å®‰å…¨çš„ Redis å®¢æˆ·ç«¯ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«åŒä¸€ä¸ª RedisConnectionï¼Œå®ƒåˆ©ç”¨ä¼˜ç§€ netty NIO æ¡†æ¶æ¥é«˜æ•ˆåœ°ç®¡ç†å¤šä¸ªè¿æ¥ã€‚</p>
<h4 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>é…ç½®æ–‡ä»¶</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redisæ•°æ®åº“ç´¢å¼•ï¼ˆé»˜è®¤ä¸º0ï¼‰</span></span><br><span class="line"><span class="meta">spring.redis.database</span>=<span class="string">0  </span></span><br><span class="line"><span class="comment"># RedisæœåŠ¡å™¨åœ°å€</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">localhost</span></span><br><span class="line"><span class="comment"># RedisæœåŠ¡å™¨è¿æ¥ç«¯å£</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379  </span></span><br><span class="line"><span class="comment"># RedisæœåŠ¡å™¨è¿æ¥å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰</span></span><br><span class="line"><span class="meta">spring.redis.password</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># è¿æ¥æ± æœ€å¤§è¿æ¥æ•°ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰ é»˜è®¤ 8</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.max-active</span>=<span class="string">8</span></span><br><span class="line"><span class="comment"># è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰ é»˜è®¤ -1</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.max-wait</span>=<span class="string">-1</span></span><br><span class="line"><span class="comment"># è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥ é»˜è®¤ 8</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.max-idle</span>=<span class="string">8</span></span><br><span class="line"><span class="comment"># è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥ é»˜è®¤ 0</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.min-idle</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>

<p><strong>æ·»åŠ  cache çš„é…ç½®ç±»</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyGenerator <span class="title">keyGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KeyGenerator() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">generate</span><span class="params">(Object target, Method method, Object... params)</span> </span>&#123;</span><br><span class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                sb.append(target.getClass().getName());</span><br><span class="line">                sb.append(method.getName());</span><br><span class="line">                <span class="keyword">for</span> (Object obj : params) &#123;</span><br><span class="line">                    sb.append(obj.toString());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> sb.toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„æˆ‘ä»¬ä½¿ç”¨äº†æ³¨è§£ï¼š<code>@EnableCaching</code>æ¥å¼€å¯ç¼“å­˜ã€‚</p>
<p><strong>æµ‹è¯•</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestRedis</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;aaa&quot;</span>, <span class="string">&quot;111&quot;</span>);</span><br><span class="line">        Assert.assertEquals(<span class="string">&quot;111&quot;</span>, stringRedisTemplate.opsForValue().get(<span class="string">&quot;aaa&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testObj</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        User user=<span class="keyword">new</span> User(<span class="string">&quot;aa@126.com&quot;</span>, <span class="string">&quot;aa&quot;</span>, <span class="string">&quot;aa123456&quot;</span>, <span class="string">&quot;aa&quot;</span>,<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        ValueOperations&lt;String, User&gt; operations=redisTemplate.opsForValue();</span><br><span class="line">        operations.set(<span class="string">&quot;com.neox&quot;</span>, user);</span><br><span class="line">        operations.set(<span class="string">&quot;com.neo.f&quot;</span>, user,<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">boolean</span> exists=redisTemplate.hasKey(<span class="string">&quot;com.neo.f&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(exists)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;exists is true&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;exists is false&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šéƒ½æ˜¯æ‰‹åŠ¨ä½¿ç”¨çš„æ–¹å¼ï¼Œå¦‚ä½•åœ¨æŸ¥æ‰¾æ•°æ®åº“çš„æ—¶å€™è‡ªåŠ¨ä½¿ç”¨ç¼“å­˜å‘¢ï¼Œçœ‹ä¸‹é¢ï¼›</p>
<p><strong>è‡ªåŠ¨æ ¹æ®æ–¹æ³•ç”Ÿæˆç¼“å­˜</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getUser&quot;)</span></span><br><span class="line">    <span class="meta">@Cacheable(value=&quot;user-key&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user=<span class="keyword">new</span> User(<span class="string">&quot;aa@126.com&quot;</span>, <span class="string">&quot;aa&quot;</span>, <span class="string">&quot;aa123456&quot;</span>, <span class="string">&quot;aa&quot;</span>,<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;è‹¥ä¸‹é¢æ²¡å‡ºç°â€œæ— ç¼“å­˜çš„æ—¶å€™è°ƒç”¨â€å­—æ ·ä¸”èƒ½æ‰“å°å‡ºæ•°æ®è¡¨ç¤ºæµ‹è¯•æˆåŠŸ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ value çš„å€¼å°±æ˜¯ç¼“å­˜åˆ° Redis ä¸­çš„ key</p>
<h4 id="è‡ªåŠ¨é…ç½®"><a href="#è‡ªåŠ¨é…ç½®" class="headerlink" title="è‡ªåŠ¨é…ç½®"></a>è‡ªåŠ¨é…ç½®</h4><p>æŸ¥çœ‹è‡ªåŠ¨é…ç½®ç±»,ä½ç½®<code>org.springframework.boot.autoconfigure.data.redis</code></p>
<ol>
<li><p>RedisAutoConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(RedisOperations.class)</span></span><br><span class="line"><span class="comment">//å±æ€§ç±»</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(RedisProperties.class)</span></span><br><span class="line"><span class="comment">//å¯¼å…¥Lettuceå’ŒJediså®¢æˆ·ç«¯é…ç½®</span></span><br><span class="line"><span class="meta">@Import(&#123; LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½“æ²¡æœ‰è‡ªå®šä¹‰redisTemplateæ—¶æ³¨å…¥ï¼Œä¾èµ–redisConnectionFactory</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean(name = &quot;redisTemplate&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">		template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">		<span class="keyword">return</span> template;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//å½“æ²¡æœ‰è‡ªå®šä¹‰stringRedisTemplateæ—¶æ³¨å…¥ï¼Œä¾èµ–redisConnectionFactory</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> StringRedisTemplate <span class="title">stringRedisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		StringRedisTemplate template = <span class="keyword">new</span> StringRedisTemplate();</span><br><span class="line">		template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">		<span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>RedisPropertiesé…ç½®å’Œé»˜è®¤å±æ€§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.redis&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Database index used by the connection factory.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> database = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Connection URL. Overrides host, port, and password. User is ignored. Example:</span></span><br><span class="line"><span class="comment">	 * redis://user:password@example.com:6379</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Redis server host.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String host = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Login password of the redis server.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Redis server port.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port = <span class="number">6379</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>LettuceConnectionConfiguration,æ³¨å…¥ClientResourceså’ŒLettuceConnectionFactoryï¼ŒJedisConnectionConfigurationä¹Ÿæ˜¯æ³¨å…¥ä¸€ä¸ªJedisConnectionFactory</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(RedisClient.class)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LettuceConnectionConfiguration</span> <span class="keyword">extends</span> <span class="title">RedisConnectionConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	LettuceConnectionConfiguration(RedisProperties properties,</span><br><span class="line">			ObjectProvider&lt;RedisSentinelConfiguration&gt; sentinelConfigurationProvider,</span><br><span class="line">			ObjectProvider&lt;RedisClusterConfiguration&gt; clusterConfigurationProvider) &#123;</span><br><span class="line">		<span class="keyword">super</span>(properties, sentinelConfigurationProvider, clusterConfigurationProvider);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean(destroyMethod = &quot;shutdown&quot;)</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean(ClientResources.class)</span></span><br><span class="line">	<span class="function">DefaultClientResources <span class="title">lettuceClientResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> DefaultClientResources.create();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean(RedisConnectionFactory.class)</span></span><br><span class="line">	<span class="function">LettuceConnectionFactory <span class="title">redisConnectionFactory</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">			ObjectProvider&lt;LettuceClientConfigurationBuilderCustomizer&gt; builderCustomizers,</span></span></span><br><span class="line"><span class="params"><span class="function">			ClientResources clientResources)</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">		LettuceClientConfiguration clientConfig = getLettuceClientConfiguration(builderCustomizers, clientResources,</span><br><span class="line">				getProperties().getLettuce().getPool());</span><br><span class="line">		<span class="keyword">return</span> createLettuceConnectionFactory(clientConfig);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>RedisTemplate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTemplate</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">RedisAccessor</span> <span class="keyword">implements</span> <span class="title">RedisOperations</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt;, <span class="title">BeanClassLoaderAware</span> </span>&#123;</span><br><span class="line"><span class="comment">//åºåˆ—åŒ–å™¨</span></span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span> <span class="keyword">private</span> <span class="meta">@Nullable</span> RedisSerializer keySerializer = <span class="keyword">null</span>;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span> <span class="keyword">private</span> <span class="meta">@Nullable</span> RedisSerializer valueSerializer = <span class="keyword">null</span>;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span> <span class="keyword">private</span> <span class="meta">@Nullable</span> RedisSerializer hashKeySerializer = <span class="keyword">null</span>;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span> <span class="keyword">private</span> <span class="meta">@Nullable</span> RedisSerializer hashValueSerializer = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">private</span> RedisSerializer&lt;String&gt; stringSerializer = RedisSerializer.string();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//luaè„šæœ¬æ‰§è¡Œå™¨</span></span><br><span class="line">    	<span class="keyword">private</span> <span class="meta">@Nullable</span> ScriptExecutor&lt;K&gt; scriptExecutor;</span><br><span class="line"><span class="comment">//æ“ä½œæ‰§è¡Œè€…</span></span><br><span class="line">   	<span class="keyword">private</span> <span class="keyword">final</span> ValueOperations&lt;K, V&gt; valueOps = <span class="keyword">new</span> DefaultValueOperations&lt;&gt;(<span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ListOperations&lt;K, V&gt; listOps = <span class="keyword">new</span> DefaultListOperations&lt;&gt;(<span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> SetOperations&lt;K, V&gt; setOps = <span class="keyword">new</span> DefaultSetOperations&lt;&gt;(<span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> StreamOperations&lt;K, ?, ?&gt; streamOps = <span class="keyword">new</span> DefaultStreamOperations&lt;&gt;(<span class="keyword">this</span>, <span class="keyword">new</span> ObjectHashMapper());</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ZSetOperations&lt;K, V&gt; zSetOps = <span class="keyword">new</span> DefaultZSetOperations&lt;&gt;(<span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> GeoOperations&lt;K, V&gt; geoOps = <span class="keyword">new</span> DefaultGeoOperations&lt;&gt;(<span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> HyperLogLogOperations&lt;K, V&gt; hllOps = <span class="keyword">new</span> DefaultHyperLogLogOperations&lt;&gt;(<span class="keyword">this</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> ClusterOperations&lt;K, V&gt; clusterOps = <span class="keyword">new</span> DefaultClusterOperations&lt;&gt;(<span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (defaultSerializer == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//é»˜è®¤åºåˆ—åŒ–å™¨</span></span><br><span class="line">                defaultSerializer = <span class="keyword">new</span> JdkSerializationRedisSerializer(</span><br><span class="line">                        classLoader != <span class="keyword">null</span> ? classLoader : <span class="keyword">this</span>.getClass().getClassLoader());</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h3><h4 id="JSR107"><a href="#JSR107" class="headerlink" title="JSR107"></a>JSR107</h4><p>JSRæ˜¯Java Specification Requests çš„ç¼©å†™ ï¼ŒJavaè§„èŒƒè¯·æ±‚ï¼Œæ•…åæ€è®®æäº¤Javaè§„èŒƒï¼Œå¤§å®¶ä¸€åŒéµå®ˆè¿™ä¸ªè§„èŒƒçš„è¯ï¼Œä¼šè®©å¤§å®¶â€˜æ²Ÿé€šâ€™èµ·æ¥æ›´åŠ è½»æ¾ï¼Œ JSR-107å‘¢å°±æ˜¯å…³äºå¦‚ä½•ä½¿ç”¨ç¼“å­˜çš„è§„èŒƒã€‚</p>
<p>å†™è¿‡ç¼“å­˜åº”ç”¨çš„ç«¥é‹éƒ½ä¼šçŸ¥é“ï¼Œä½¿ç”¨ç¼“å­˜å¤§æ¦‚æœ‰ä»¥ä¸‹æ­¥éª¤</p>
<ol>
<li><p>å‘ç”µè„‘ç”³è¯·ä¸€å—ç©ºé—´ä½œä¸ºç¼“å­˜</p>
</li>
<li><p>ä¸ºç¼“å­˜å®šä¹‰ä½ è‡ªå·±çš„æ•°æ®ç»“æ„</p>
</li>
<li><p>å‘ç¼“å­˜ä¸­å†™æ•°æ®</p>
</li>
<li><p>ä»ç¼“å­˜ä¸­è¯»æ•°æ®</p>
</li>
<li><p>ä¸å†ä½¿ç”¨ç¼“å­˜æ—¶ï¼Œæ¸…ç©ºä½ é”ç”³è¯·çš„å†…å­˜ç©ºé—´</p>
</li>
</ol>
<p>å¤§æ¦‚è¿™ä¹ˆå¤šå§ï¼Œå½“ç„¶é‡Œé¢è¿˜æœ‰å¾ˆå¤šç»†èŠ‚æ€§çš„ä¸œè¥¿ï¼Œæ¯”å¦‚è¿‡æœŸè®¾ç½®å‘€ï¼Œåˆ†å¸ƒå¼è®¾ç½®å‘€ï¼Œæ˜¯ä¸æ˜¯è¦æŒä¹…åŒ–å‘€ï¼Œæ˜¯ä¸æ˜¯è¦æ”¯æŒäº‹åŠ¡å‘€ï¼Œè¦ä¸è¦åŠ é”å‘€â€¦â€¦.</p>
<p>JSR-107å‘¢å°±æ˜¯å¯¹ç¼“å­˜å¸¸ç”¨çš„æ“ä½œåšäº†ä¸€ä¸ªæŠ½è±¡ï¼Œç„¶åç»™å‡ºä¸€ä¸ªAPIæ¥å£ï¼Œä¸åŒçš„ç¼“å­˜äº§å“åªè¦å®ç°äº†è¿™äº›æ¥å£å°±å¯ä»¥äº†ã€‚ä½¿ç”¨ç¼“å­˜çš„ç”¨æˆ·èƒ½ä¹Ÿåªè¦è°ƒç”¨è¿™äº›æ¥å£å°±èƒ½å¾—åˆ°ä¸åŒäº§å“çš„ç¼“å­˜æœåŠ¡ï¼Œè€Œä¸ç”¨æ‚²å‚¬çš„æ¥æ¥å›å›å­¦ä¹ ä¸åŒç¼“å­˜çš„APIï¼Œæ›´åŠ æ‚²å‚¬çš„æ˜¯APIè¿˜æ²¡æœ‰çœ‹æ˜ç™½ï¼ŒæŸæŠ€æœ¯å°±å·²ç»é»„äº†ã€‚</p>
<p>javaCachingå®šä¹‰äº†äº”ä¸ªæ ¸å¿ƒæ¥å£ï¼šCacheProviderï¼ŒCacheManagerï¼ŒCacheï¼ŒEntryï¼ˆè®°å½•ï¼‰ å’Œ Expiryã€‚ï¼Œ</p>
<ol>
<li>CachingProviderå®šä¹‰äº†åˆ›å»ºã€é…ç½®ã€è·å–ã€ç®¡ç†å’Œæ§åˆ¶å¤šä¸ªCacheManagerã€‚ä¸€ä¸ªåº”ç”¨å¯ ä»¥åœ¨è¿è¡ŒæœŸè®¿é—®å¤šä¸ªCachingProviderã€‚</li>
<li>CacheManagerå®šä¹‰äº†åˆ›å»ºã€é…ç½®ã€è·å–ã€ç®¡ç†å’Œæ§åˆ¶å¤šä¸ªå”¯ä¸€å‘½åçš„Cacheï¼Œè¿™äº›Cache å­˜åœ¨äºCacheManagerçš„ä¸Šä¸‹æ–‡ä¸­ã€‚ä¸€ä¸ªCacheManagerä»…è¢«ä¸€ä¸ªCachingProvideræ‰€æ‹¥æœ‰ã€‚</li>
<li>Cacheæ˜¯ä¸€ä¸ªç±»ä¼¼Mapçš„æ•°æ®ç»“æ„å¹¶ä¸´æ—¶å­˜å‚¨ä»¥Keyä¸ºç´¢å¼•çš„å€¼ã€‚ä¸€ä¸ªCacheä»…è¢«ä¸€ä¸ª CacheManageræ‰€æ‹¥æœ‰ã€‚</li>
<li>Entryæ˜¯ä¸€ä¸ªå­˜å‚¨åœ¨Cacheä¸­çš„key-valueå¯¹ã€‚</li>
<li>Expiry æ¯ä¸€ä¸ªå­˜å‚¨åœ¨Cacheä¸­çš„æ¡ç›®æœ‰ä¸€ä¸ªå®šä¹‰çš„æœ‰æ•ˆæœŸã€‚ä¸€æ—¦è¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œæ¡ç›®ä¸ºè¿‡æœŸ çš„çŠ¶æ€ã€‚ä¸€æ—¦è¿‡æœŸï¼Œæ¡ç›®å°†ä¸å¯è®¿é—®ã€æ›´æ–°å’Œåˆ é™¤ã€‚ç¼“å­˜æœ‰æ•ˆæœŸå¯ä»¥é€šè¿‡ExpiryPolicyè®¾ç½®ã€‚</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/01/03/lNhqfO.png" alt="lNhqfO.png"></p>
<p>ä½¿ç”¨javaCacheéœ€è¦ä¾èµ–çš„åŒ…æ˜¯ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.cache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cache-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Springç¼“å­˜æŠ½è±¡"><a href="#Springç¼“å­˜æŠ½è±¡" class="headerlink" title="Springç¼“å­˜æŠ½è±¡"></a>Springç¼“å­˜æŠ½è±¡</h4><p>Springå®šä¹‰äº†org.springframework.cache.Cacheå’Œorg.springframework.cache.CacheManageræ¥å£æ¥ç»Ÿä¸€ä¸åŒçš„ç¼“å­˜æŠ€æœ¯ã€‚å¹¶æ”¯æŒä½¿ç”¨JCacheï¼ˆJSR-107ï¼‰æ³¨è§£ç®€åŒ–å¼€å‘ã€‚</p>
<p>Cacheæ¥å£ä¸ºç¼“å­˜çš„ç»„ä»¶è§„èŒƒå®šä¹‰ï¼ŒåŒ…å«ç¼“å­˜çš„å„ç§æ“ä½œé›†åˆã€‚</p>
<p>Cacheæ¥å£ä¸‹Springæä¾›äº†å„ç§xxCacheçš„å®ç°ï¼›å¦‚RedisCacheã€EnCacheCacheã€ConcurrentMapCacheã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/01/03/lN5JG8.png" alt="lN5JG8.png"></p>
<h5 id="å‡ ä¸ªé‡è¦æ¦‚å¿µ-amp-ç¼“å­˜æ³¨è§£"><a href="#å‡ ä¸ªé‡è¦æ¦‚å¿µ-amp-ç¼“å­˜æ³¨è§£" class="headerlink" title="å‡ ä¸ªé‡è¦æ¦‚å¿µ&amp;ç¼“å­˜æ³¨è§£"></a>å‡ ä¸ªé‡è¦æ¦‚å¿µ&amp;ç¼“å­˜æ³¨è§£</h5><p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/01/03/lNhvXd.png" alt="lNhvXd.png"></p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/01/03/lN4S0I.png" alt="lN4S0I.png"></p>
<p><strong>@Cacheable</strong></p>
<p>@Cacheableå¯ä»¥æ ‡è®°åœ¨ä¸€ä¸ªæ–¹æ³•ä¸Šï¼Œä¹Ÿå¯ä»¥æ ‡è®°åœ¨ä¸€ä¸ªç±»ä¸Šã€‚å½“æ ‡è®°åœ¨ä¸€ä¸ªæ–¹æ³•ä¸Šæ—¶è¡¨ç¤ºè¯¥æ–¹æ³•æ˜¯æ”¯æŒç¼“å­˜çš„ï¼Œå½“æ ‡è®°åœ¨ä¸€ä¸ªç±»ä¸Šæ—¶åˆ™è¡¨ç¤ºè¯¥ç±»æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯æ”¯æŒç¼“å­˜çš„ã€‚å¯¹äºä¸€ä¸ªæ”¯æŒç¼“å­˜çš„æ–¹æ³•ï¼ŒSpringä¼šåœ¨å…¶è¢«è°ƒç”¨åå°†å…¶è¿”å›å€¼ç¼“å­˜èµ·æ¥ï¼Œä»¥ä¿è¯ä¸‹æ¬¡åˆ©ç”¨åŒæ ·çš„å‚æ•°æ¥æ‰§è¡Œè¯¥æ–¹æ³•æ—¶å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ç»“æœï¼Œè€Œä¸éœ€è¦å†æ¬¡æ‰§è¡Œè¯¥æ–¹æ³•ã€‚Springåœ¨ç¼“å­˜æ–¹æ³•çš„è¿”å›å€¼æ—¶æ˜¯ä»¥é”®å€¼å¯¹è¿›è¡Œç¼“å­˜çš„ï¼Œå€¼å°±æ˜¯æ–¹æ³•çš„è¿”å›ç»“æœï¼Œè‡³äºé”®çš„è¯ï¼ŒSpringåˆæ”¯æŒä¸¤ç§ç­–ç•¥ï¼Œé»˜è®¤ç­–ç•¥å’Œè‡ªå®šä¹‰ç­–ç•¥ï¼Œè¿™ä¸ªç¨åä¼šè¿›è¡Œè¯´æ˜ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å½“ä¸€ä¸ªæ”¯æŒç¼“å­˜çš„æ–¹æ³•åœ¨å¯¹è±¡å†…éƒ¨è¢«è°ƒç”¨æ—¶æ˜¯ä¸ä¼šè§¦å‘ç¼“å­˜åŠŸèƒ½çš„ã€‚@Cacheableå¯ä»¥æŒ‡å®šä¸‰ä¸ªå±æ€§ï¼Œvalue(Cacheåç§°)ã€key(è‡ªå®šä¹‰key)å’Œconditionã€‚</p>
<ol>
<li><p>valueå±æ€§æ˜¯å¿…é¡»æŒ‡å®šçš„ï¼Œå…¶è¡¨ç¤ºå½“å‰æ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¼šè¢«ç¼“å­˜åœ¨å“ªä¸ªCacheä¸Šçš„ï¼Œå¯¹åº”Cacheçš„åç§°ã€‚å…¶å¯ä»¥æ˜¯ä¸€ä¸ªCacheä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªCacheï¼Œå½“éœ€è¦æŒ‡å®šå¤šä¸ªCacheæ—¶å…¶æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚</p>
</li>
<li><p>keyå±æ€§æ˜¯ç”¨æ¥æŒ‡å®šSpringç¼“å­˜æ–¹æ³•çš„è¿”å›ç»“æœæ—¶å¯¹åº”çš„keyçš„ã€‚è¯¥å±æ€§æ”¯æŒSpringELè¡¨è¾¾å¼ã€‚å½“æˆ‘ä»¬æ²¡æœ‰æŒ‡å®šè¯¥å±æ€§æ—¶ï¼ŒSpringå°†ä½¿ç”¨é»˜è®¤ç­–ç•¥ç”Ÿæˆkeyã€‚é»˜è®¤ä½¿ç”¨å‚æ•°ä½œä¸ºkey</p>
<p>å¦‚æœè¦åŠ¨æ€æ‹¼æ¥keyä¹Ÿå¯ä»¥ï¼Œkey=â€#root.methodName+â€™[â€˜+#å‚æ•°å±æ€§å+â€™]â€™â€ä¼šè¢«æ‹¼æ¥ä¸ºæ–¹æ³•åã€å‚æ•°ã€‘</p>
<p>conditionè‡ªå®šä¹‰ç­–ç•¥æ˜¯æŒ‡æˆ‘ä»¬å¯ä»¥é€šè¿‡Springçš„ELè¡¨è¾¾å¼æ¥æŒ‡å®šæˆ‘ä»¬çš„keyã€‚è¿™é‡Œçš„ELè¡¨è¾¾å¼å¯ä»¥ä½¿ç”¨æ–¹æ³•å‚æ•°åŠå®ƒä»¬å¯¹åº”çš„å±æ€§ã€‚ä½¿ç”¨æ–¹æ³•å‚æ•°æ—¶æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨â€œ#å‚æ•°åâ€æˆ–è€…â€œ#på‚æ•°indexâ€ã€‚</p>
<p>é™¤äº†ä¸Šè¿°ä½¿ç”¨æ–¹æ³•å‚æ•°ä½œä¸ºkeyä¹‹å¤–ï¼ŒSpringè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªrootå¯¹è±¡å¯ä»¥ç”¨æ¥ç”Ÿæˆkeyã€‚é€šè¿‡è¯¥rootå¯¹è±¡æˆ‘ä»¬å¯ä»¥è·å–åˆ°ä»¥ä¸‹ä¿¡æ¯ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/01/03/lN59KJ.png" alt="lN59KJ.png"></p>
</li>
<li><p>keyGeneratorï¼škeyçš„ç”Ÿæˆå™¨ï¼Œå¯ä»¥è‡ªå·±æŒ‡å®škeyç”Ÿæˆå™¨çš„ç»„ä»¶id</p>
<p>keyå’ŒkeyGeneratorï¼šäºŒé€‰ä¸€ä½¿ç”¨</p>
</li>
<li><p>conditionå±æ€§æŒ‡å®šå‘ç”Ÿçš„æ¡ä»¶ </p>
<p>æœ‰çš„æ—¶å€™æˆ‘ä»¬å¯èƒ½å¹¶ä¸å¸Œæœ›ç¼“å­˜ä¸€ä¸ªæ–¹æ³•æ‰€æœ‰çš„è¿”å›ç»“æœã€‚é€šè¿‡conditionå±æ€§å¯ä»¥å®ç°è¿™ä¸€åŠŸèƒ½ã€‚conditionå±æ€§é»˜è®¤ä¸ºç©ºï¼Œè¡¨ç¤ºå°†ç¼“å­˜æ‰€æœ‰çš„è°ƒç”¨æƒ…å½¢ã€‚å…¶å€¼æ˜¯é€šè¿‡SpringELè¡¨è¾¾å¼æ¥æŒ‡å®šçš„ï¼Œå½“ä¸ºtrueæ—¶è¡¨ç¤ºè¿›è¡Œç¼“å­˜å¤„ç†ï¼›å½“ä¸ºfalseæ—¶è¡¨ç¤ºä¸è¿›è¡Œç¼“å­˜å¤„ç†ï¼Œå³æ¯æ¬¡è°ƒç”¨è¯¥æ–¹æ³•æ—¶è¯¥æ–¹æ³•éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ã€‚å¦‚ä¸‹ç¤ºä¾‹è¡¨ç¤ºåªæœ‰å½“userçš„idä¸ºå¶æ•°æ—¶æ‰ä¼šè¿›è¡Œç¼“å­˜ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Cacheable(value=&#123;â€œusersâ€&#125;, key=â€#user.idâ€, condition=â€#user.id%2==0â€)</span><br></pre></td></tr></table></figure></li>
<li><p>cacheManager/cacheResolveræŒ‡å®šç¼“å­˜ç®¡ç†å™¨ï¼Œå› ä¸ºç¼“å­˜ç®¡ç†å™¨é‡Œé¢çš„cacheæœ‰äº›æ˜¯å­˜åœ¨ConcurrentHashMapé‡Œé¢çš„ï¼Œæœ‰äº›äº‹å­˜åœ¨Redisé‡Œé¢çš„ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/01/03/lN5VPK.png" alt="lN5VPK.png"></p>
</li>
<li><p>unlessï¼šå¦å®šç¼“å­˜ï¼ŒæŒ‡å®šæ¡ä»¶ä¸ºtrueï¼Œåˆ™ä¸ç¼“å­˜ï¼Œä¸conditionç›¸å</p>
</li>
<li><p>syncï¼šæ˜¯å¦ä½¿ç”¨å¼‚æ­¥æ¨¡å¼ï¼Œä¸èƒ½åŒæ—¶å’Œunlessä½¿ç”¨</p>
</li>
</ol>
<p><strong>@CachePut</strong></p>
<p>åœ¨æ”¯æŒSpring Cacheçš„ç¯å¢ƒä¸‹ï¼Œå¯¹äºä½¿ç”¨@Cacheableæ ‡æ³¨çš„æ–¹æ³•ï¼ŒSpringåœ¨æ¯æ¬¡æ‰§è¡Œå‰éƒ½ä¼šæ£€æŸ¥Cacheä¸­æ˜¯å¦å­˜åœ¨ç›¸åŒkeyçš„ç¼“å­˜å…ƒç´ ï¼Œå¦‚æœå­˜åœ¨å°±ä¸å†æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œè€Œæ˜¯ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ç»“æœè¿›è¡Œè¿”å›ï¼Œå¦åˆ™æ‰ä¼šæ‰§è¡Œå¹¶å°†è¿”å›ç»“æœå­˜å…¥æŒ‡å®šçš„ç¼“å­˜ä¸­ã€‚@CachePutä¹Ÿå¯ä»¥å£°æ˜ä¸€ä¸ªæ–¹æ³•æ”¯æŒç¼“å­˜åŠŸèƒ½ã€‚ä¸@Cacheableä¸åŒçš„æ˜¯ä½¿ç”¨@CachePutæ ‡æ³¨çš„æ–¹æ³•åœ¨æ‰§è¡Œå‰ä¸ä¼šå»æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨ä¹‹å‰æ‰§è¡Œè¿‡çš„ç»“æœï¼Œè€Œæ˜¯æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œè¯¥æ–¹æ³•ï¼Œå¹¶å°†æ‰§è¡Œç»“æœä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å…¥æŒ‡å®šçš„ç¼“å­˜ä¸­ã€‚</p>
<p><strong>@CacheEvict</strong></p>
<p>@CacheEvictæ˜¯ç”¨æ¥æ ‡æ³¨åœ¨éœ€è¦æ¸…é™¤ç¼“å­˜å…ƒç´ çš„æ–¹æ³•æˆ–ç±»ä¸Šçš„ã€‚å½“æ ‡è®°åœ¨ä¸€ä¸ªç±»ä¸Šæ—¶è¡¨ç¤ºå…¶ä¸­æ‰€æœ‰çš„æ–¹æ³•çš„æ‰§è¡Œéƒ½ä¼šè§¦å‘ç¼“å­˜çš„æ¸…é™¤æ“ä½œã€‚@CacheEvictå¯ä»¥æŒ‡å®šçš„å±æ€§æœ‰valueã€keyã€conditionã€allEntrieså’ŒbeforeInvocationã€‚å…¶ä¸­valueã€keyå’Œconditionçš„è¯­ä¹‰ä¸@Cacheableå¯¹åº”çš„å±æ€§ç±»ä¼¼ã€‚å³valueè¡¨ç¤ºæ¸…é™¤æ“ä½œæ˜¯å‘ç”Ÿåœ¨å“ªäº›Cacheä¸Šçš„ï¼ˆå¯¹åº”Cacheçš„åç§°ï¼‰ï¼›keyè¡¨ç¤ºéœ€è¦æ¸…é™¤çš„æ˜¯å“ªä¸ªkeyï¼Œå¦‚æœªæŒ‡å®šåˆ™ä¼šä½¿ç”¨é»˜è®¤ç­–ç•¥ç”Ÿæˆçš„keyï¼›conditionè¡¨ç¤ºæ¸…é™¤æ“ä½œå‘ç”Ÿçš„æ¡ä»¶ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹æ–°å‡ºç°çš„ä¸¤ä¸ªå±æ€§allEntrieså’ŒbeforeInvocationã€‚</p>
<ul>
<li><p>allEntriesæ˜¯booleanç±»å‹ï¼Œè¡¨ç¤ºæ˜¯å¦éœ€è¦æ¸…é™¤ç¼“å­˜ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚é»˜è®¤ä¸ºfalseï¼Œè¡¨ç¤ºä¸éœ€è¦ã€‚å½“æŒ‡å®šäº†allEntriesä¸ºtrueæ—¶ï¼ŒSpring Cacheå°†å¿½ç•¥æŒ‡å®šçš„keyã€‚æœ‰çš„æ—¶å€™æˆ‘ä»¬éœ€è¦Cacheä¸€ä¸‹æ¸…é™¤æ‰€æœ‰çš„å…ƒç´ ï¼Œè¿™æ¯”ä¸€ä¸ªä¸€ä¸ªæ¸…é™¤å…ƒç´ æ›´æœ‰æ•ˆç‡ã€‚</p>
</li>
<li><p>æ¸…é™¤æ“ä½œé»˜è®¤æ˜¯åœ¨å¯¹åº”æ–¹æ³•æˆåŠŸæ‰§è¡Œä¹‹åè§¦å‘çš„ï¼Œå³æ–¹æ³•å¦‚æœå› ä¸ºæŠ›å‡ºå¼‚å¸¸è€Œæœªèƒ½æˆåŠŸè¿”å›æ—¶ä¹Ÿä¸ä¼šè§¦å‘æ¸…é™¤æ“ä½œã€‚ä½¿ç”¨beforeInvocationå¯ä»¥æ”¹å˜è§¦å‘æ¸…é™¤æ“ä½œçš„æ—¶é—´ï¼Œå½“æˆ‘ä»¬æŒ‡å®šè¯¥å±æ€§å€¼ä¸ºtrueæ—¶ï¼ŒSpringä¼šåœ¨è°ƒç”¨è¯¥æ–¹æ³•ä¹‹å‰æ¸…é™¤ç¼“å­˜ä¸­çš„æŒ‡å®šå…ƒç´ ã€‚</p>
</li>
</ul>
<p><strong>@Caching</strong></p>
<p>@Cachingæ³¨è§£å¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸€ä¸ªæ–¹æ³•æˆ–è€…ç±»ä¸ŠåŒæ—¶æŒ‡å®šå¤šä¸ªSpring Cacheç›¸å…³çš„æ³¨è§£ã€‚å…¶æ‹¥æœ‰ä¸‰ä¸ªå±æ€§ï¼šcacheableã€putå’Œevictï¼Œåˆ†åˆ«ç”¨äºæŒ‡å®š@Cacheableã€@CachePutå’Œ@CacheEvictã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Caching(cacheable = @Cacheable(â€œusersâ€), evict = &#123; @CacheEvict(â€œcache2â€),</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">         @CacheEvict(value = â€œcache3â€, allEntries = true) &#125;)</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">find</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      returnnull;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£</strong></p>
<p> Springå…è®¸æˆ‘ä»¬åœ¨é…ç½®å¯ç¼“å­˜çš„æ–¹æ³•æ—¶ä½¿ç”¨è‡ªå®šä¹‰çš„æ³¨è§£ï¼Œå‰ææ˜¯è‡ªå®šä¹‰çš„æ³¨è§£ä¸Šå¿…é¡»ä½¿ç”¨å¯¹åº”çš„æ³¨è§£è¿›è¡Œæ ‡æ³¨ã€‚å¦‚æˆ‘ä»¬æœ‰å¦‚ä¸‹è¿™ä¹ˆä¸€ä¸ªä½¿ç”¨@Cacheableè¿›è¡Œæ ‡æ³¨çš„è‡ªå®šä¹‰æ³¨è§£ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Cacheable(value=â€usersâ€)</span><br><span class="line">public @interface MyCacheable &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆåœ¨æˆ‘ä»¬éœ€è¦ç¼“å­˜çš„æ–¹æ³•ä¸Šä½¿ç”¨@MyCacheableè¿›è¡Œæ ‡æ³¨ä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@MyCacheable</span><br><span class="line">   public User findById(Integer id) &#123;</span><br><span class="line">      System.out.println(â€œfind user by id: â€œ + id);</span><br><span class="line">      User user = new User();</span><br><span class="line">      user.setId(id);</span><br><span class="line">      user.setName(â€œNameâ€ + id);</span><br><span class="line">      return user;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.200<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>é…ç½®</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.h2.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:h2:mem:data</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span></span><br><span class="line">    <span class="attr">schema:</span> <span class="string">classpath:db/schema.sql</span></span><br><span class="line">    <span class="attr">data:</span> <span class="string">classpath:db/data.sql</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="comment">#  mapper-locations: mapper/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.hyp.learn.cache.entity</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment">#è‡ªåŠ¨é©¼å³°å‘½åè§„åˆ™( camel case )æ˜ å°„</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/cache</span></span><br></pre></td></tr></table></figure>

<p>sqlæ–‡ä»¶</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- éƒ¨é—¨è¡¨</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> tbl_dept</span><br><span class="line">(</span><br><span class="line">  id        <span class="type">integer</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">  dept_name <span class="type">varchar</span>(<span class="number">50</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å‘˜å·¥è¡¨</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> tbl_employee</span><br><span class="line">(</span><br><span class="line">  id        <span class="type">integer</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">  last_name <span class="type">varchar</span>(<span class="number">50</span>),</span><br><span class="line">  email     <span class="type">varchar</span>(<span class="number">50</span>),</span><br><span class="line">  gender    <span class="type">varchar</span>(<span class="number">5</span>),</span><br><span class="line">  d_id      <span class="type">integer</span>,</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> fk_e_e <span class="keyword">FOREIGN</span> KEY (d_id) <span class="keyword">REFERENCES</span> tbl_dept (id)</span><br><span class="line"></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ·»åŠ data</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl_dept</span><br><span class="line"><span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;å¼€å‘éƒ¨é—¨&#x27;</span>),</span><br><span class="line">       (<span class="number">2</span>, <span class="string">&#x27;é”€å”®éƒ¨é—¨&#x27;</span>),</span><br><span class="line">       (<span class="number">3</span>, <span class="string">&#x27;å”®åéƒ¨é—¨&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl_employee</span><br><span class="line"><span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;lisa&#x27;</span>, <span class="string">&#x27;123@123.com&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">       (<span class="number">2</span>, <span class="string">&#x27;tom&#x27;</span>, <span class="string">&#x27;123@456.com&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="number">2</span>),</span><br><span class="line">       (<span class="number">3</span>, <span class="string">&#x27;lisa2&#x27;</span>, <span class="string">&#x27;123@123.com&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">       (<span class="number">4</span>, <span class="string">&#x27;lisa3&#x27;</span>, <span class="string">&#x27;123@123.com&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">       (<span class="number">5</span>, <span class="string">&#x27;lisa4&#x27;</span>, <span class="string">&#x27;123@123.com&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="number">2</span>),</span><br><span class="line">       (<span class="number">6</span>, <span class="string">&#x27;lisa5&#x27;</span>, <span class="string">&#x27;123@123.com&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">       (<span class="number">7</span>, <span class="string">&#x27;lisa6&#x27;</span>, <span class="string">&#x27;123@123.com&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">       (<span class="number">8</span>, <span class="string">&#x27;lisa7&#x27;</span>, <span class="string">&#x27;123@123.com&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="number">2</span>),</span><br><span class="line">       (<span class="number">9</span>, <span class="string">&#x27;lisa8&#x27;</span>, <span class="string">&#x27;123@123.com&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">       (<span class="number">10</span>, <span class="string">&#x27;lisa9&#x27;</span>, <span class="string">&#x27;123@123.com&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">       (<span class="number">11</span>, <span class="string">&#x27;lisa10&#x27;</span>, <span class="string">&#x27;123@123.com&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="number">2</span>),</span><br><span class="line">       (<span class="number">12</span>, <span class="string">&#x27;lisa11&#x27;</span>, <span class="string">&#x27;123@123.com&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">       (<span class="number">13</span>, <span class="string">&#x27;lisa12&#x27;</span>, <span class="string">&#x27;123@123.com&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å®ä½“ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Alias(&quot;Employee&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>daoç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmployeeMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from tbl_employee where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmpById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert(&quot;Insert into tbl_employee(lastName,email,gender,d_id) Values(#&#123;lastName&#125;,#&#123;email&#125;,#&#123;gender&#125;,#&#123;dId&#125;) &quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">addEmp</span><span class="params">(Employee employee)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&quot;Update tbl_employee set lastName=#&#123;lastName&#125;,email=#&#123;email&#125;,gender=#&#123;gender&#125;,d_id=#&#123;dId&#125;)</span> where id=#&#123;id&#125;<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public boolean updateEmp(Employee employee);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @Delete(&quot;</span>delete tbl_employee where id =#&#123;id&#125;<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public boolean deleteEmpById(Integer id);</span></span><br><span class="line"><span class="string">        @Select(&quot;</span>select * from tbl_employee where last_name like #&#123;name&#125; limit <span class="number">0</span>,<span class="number">1</span><span class="string">&quot;)</span></span><br><span class="line"><span class="string">    public Employee getEmpByName(String name);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>serviceç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="comment">//ç¼“å­˜å…¬å…±é…ç½®</span></span><br><span class="line"><span class="meta">@CacheConfig(cacheNames = &quot;px_employee&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmployeeService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeMapper employeeMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†æ–¹æ³•çš„è¿è¡Œç»“æœè¿›è¡Œç¼“å­˜ï¼Œä»¥åå†è¦ç›¸åŒçš„è°ƒç”¨å‚æ•°ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­å–å‡ºï¼Œä¸ç”¨è°ƒç”¨æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * å…ˆè°ƒç”¨ç¼“å­˜ï¼Œå†å¯èƒ½æ‰§è¡Œæ–¹æ³•ï¼Œå› æ­¤ä¸èƒ½åœ¨Cacheableä½¿ç”¨#result</span></span><br><span class="line"><span class="comment">     * 1.cacheName/valueï¼šæŒ‡å®šcacheç»„ä»¶çš„åç§°ï¼Œå¯ä»¥æŒ‡å®šå•/å¤šä¸ªï¼š</span></span><br><span class="line"><span class="comment">     * keyï¼šè¦æŒ‰SpELè¡¨è¾¾å¼å»å†™ï¼Œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="comment">//    @Cacheable(cacheNames = &quot;px_employee&quot;,  keyGenerator = &quot;myKeyGenerator&quot;,condition = &quot;#a0&gt;1&quot;, unless = &quot;#result == null&quot;)</span></span><br><span class="line">    <span class="meta">@Cacheable(cacheNames = &quot;px_employee&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmp</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æŸ¥è¯¢&quot;</span> + id + <span class="string">&quot;å‘˜å·¥&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> employeeMapper.getEmpById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CachePut</span>:åŠè°ƒç”¨æ–¹æ³•ï¼Œæœ‰æ›´æ–°ç¼“å­˜æ•°æ®</span></span><br><span class="line"><span class="comment">     * å…ˆè°ƒç”¨ç›®æ ‡æ–¹æ³•ï¼Œå†æ›´æ–°ç¼“å­˜</span></span><br><span class="line"><span class="comment">     keyè¦å’ŒCacheableä¸­çš„keyç›¸åŒæ‰èƒ½æ›´æ–°åŒä¸€ç¼“å­˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employee</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@CachePut(cacheNames = &quot;px_employee&quot;,key = &quot;#result.id&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">update</span><span class="params">(Employee employee)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;update&quot;</span> + employee + <span class="string">&quot;å‘˜å·¥&quot;</span>);</span><br><span class="line"></span><br><span class="line">        employeeMapper.updateEmp(employee);</span><br><span class="line">         <span class="keyword">return</span> employee;</span><br><span class="line">    &#125;</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *æ¸…é™¤æ“ä½œé»˜è®¤æ˜¯åœ¨å¯¹åº”æ–¹æ³•æˆåŠŸæ‰§è¡Œä¹‹åè§¦å‘çš„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@CacheEvict(cacheNames = &quot;px_employee&quot;,beforeInvocation = true)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(Integer id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;åˆ é™¤&quot;</span> + id + <span class="string">&quot;å‘˜å·¥&quot;</span>);</span><br><span class="line">        employeeMapper.deleteEmpById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Caching(</span></span><br><span class="line"><span class="meta">            cacheable = &#123;</span></span><br><span class="line"><span class="meta">                    @Cacheable(cacheNames = &quot;px_employee&quot;, key = &quot;#name&quot;)</span></span><br><span class="line"><span class="meta">            &#125;,</span></span><br><span class="line"><span class="meta">            put = &#123;</span></span><br><span class="line"><span class="meta">                    @CachePut(cacheNames = &quot;px_employee&quot;, key = &quot;#result.id&quot;),</span></span><br><span class="line"><span class="meta">                    @CachePut(cacheNames = &quot;px_employee&quot;, key = &quot;#result.email&quot;)</span></span><br><span class="line"><span class="meta">            &#125;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmpByName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> employeeMapper.getEmpByName(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controllerç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/emp&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmploeeController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeService employeeService;</span><br><span class="line"></span><br><span class="line">     <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmp</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> employeeService.getEmp(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">update</span><span class="params">(<span class="meta">@RequestBody</span> Employee employee)</span> </span>&#123;</span><br><span class="line">        employeeService.update(employee);</span><br><span class="line">        <span class="keyword">return</span> employee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/del/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">delete</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span> </span>&#123;</span><br><span class="line">        employeeService.delete(id);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;åˆ é™¤æˆåŠŸ&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/name/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Employee <span class="title">getEmpByName</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> employeeService.getEmpByName(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç±»ä¸Šæ·»åŠ <code>@EnableCaching</code>æ³¨è§£ </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.hyp.learn.cache.dao&quot;)</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// devtoolsï¼šæ˜¯spring bootçš„ä¸€ä¸ªçƒ­éƒ¨ç½²å·¥å…·</span></span><br><span class="line">        <span class="comment">//è®¾ç½® spring.devtools.restart.enabled å±æ€§ä¸ºfalseï¼Œå¯ä»¥å…³é—­è¯¥ç‰¹æ€§.</span></span><br><span class="line">        <span class="comment">//System.setProperty(&quot;spring.devtools.restart.enabled&quot;,&quot;false&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯åŠ¨Sprign Boot</span></span><br><span class="line">        ConfigurableApplicationContext ctx = SpringApplication.run(CacheApplication.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Let&#x27;s inspect the beans provided by Spring Boot:&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String[] beanNames = ctx.getBeanDefinitionNames();</span><br><span class="line">        Arrays.sort(beanNames);</span><br><span class="line">        <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">            System.out.println(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è‡ªå®šä¹‰KeyGenerator</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;myKeyGenerator&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyGenerator <span class="title">keyGenerator</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KeyGenerator() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">generate</span><span class="params">(Object target, Method method, Object... params)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> method.getName()+<span class="string">&quot;[&quot;</span>+Arrays.asList(params).toString() +<span class="string">&quot;]&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œæµ‹è¯•ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆ</p>
<h4 id="ç¼“å­˜åŸç†"><a href="#ç¼“å­˜åŸç†" class="headerlink" title="ç¼“å­˜åŸç†"></a>ç¼“å­˜åŸç†</h4><p>è‡ªåŠ¨é…ç½®ç±»ä½ç½®ï¼šorg.springframework.boot.autoconfigure.cache</p>
<ol>
<li><p>CacheAutoConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="comment">//ç”Ÿæ•ˆæ¡ä»¶</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(CacheManager.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(CacheAspectSupport.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(value = CacheManager.class, name = &quot;cacheResolver&quot;)</span></span><br><span class="line"><span class="comment">//é…ç½®å±æ€§ç±»</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(CacheProperties.class)</span></span><br><span class="line"><span class="comment">//åœ¨è¿™äº›è‡ªåŠ¨é…ç½®å®Œæˆä¹‹åè¿›è¡Œé…ç½®</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(&#123; CouchbaseAutoConfiguration.class, HazelcastAutoConfiguration.class,</span></span><br><span class="line"><span class="meta">		HibernateJpaAutoConfiguration.class, RedisAutoConfiguration.class &#125;)</span></span><br><span class="line"><span class="comment">//å®é™…é…ç½®çš„ç±»</span></span><br><span class="line"><span class="meta">@Import(&#123; CacheConfigurationImportSelector.class, CacheManagerEntityManagerFactoryDependsOnPostProcessor.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CacheManagerCustomizers <span class="title">cacheManagerCustomizers</span><span class="params">(ObjectProvider&lt;CacheManagerCustomizer&lt;?&gt;&gt; customizers)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> CacheManagerCustomizers(customizers.orderedStream().collect(Collectors.toList()));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CacheManagerValidator <span class="title">cacheAutoConfigurationValidator</span><span class="params">(CacheProperties cacheProperties,</span></span></span><br><span class="line"><span class="params"><span class="function">			ObjectProvider&lt;CacheManager&gt; cacheManager)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> CacheManagerValidator(cacheProperties, cacheManager);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@ConditionalOnClass(LocalContainerEntityManagerFactoryBean.class)</span></span><br><span class="line">	<span class="meta">@ConditionalOnBean(AbstractEntityManagerFactoryBean.class)</span></span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheManagerEntityManagerFactoryDependsOnPostProcessor</span></span></span><br><span class="line"><span class="class">			<span class="keyword">extends</span> <span class="title">EntityManagerFactoryDependsOnPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		CacheManagerEntityManagerFactoryDependsOnPostProcessor() &#123;</span><br><span class="line">			<span class="keyword">super</span>(<span class="string">&quot;cacheManager&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@link</span> ImportSelector&#125; to add &#123;<span class="doctag">@link</span> CacheType&#125; configuration classes.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">			CacheType[] types = CacheType.values();</span><br><span class="line">			String[] imports = <span class="keyword">new</span> String[types.length];</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; types.length; i++) &#123;</span><br><span class="line">				imports[i] = CacheConfigurations.getConfigurationClass(types[i]);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> imports;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>CacheConfigurationImportSelectorå¯¼å…¥cacheçš„é…ç½®bean</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/01/03/lN5WL9.png" alt="lN5WL9.png"></p>
<p>å¯ä»¥çœ‹åˆ°æ”¯æŒnopï¼ˆæ— ï¼‰ã€simpleã€JSR107ã€ehcachaã€hazelcastã€Infinispanã€Couchbaseã€Redisã€Caffeineç­‰ç¼“å­˜çš„é…ç½®æ–¹å¼ï¼Œé»˜è®¤æ˜¯SimpleCacheConfigurationé…ç½®</p>
</li>
<li><p>SimpleCacheConfigurationæ³¨å†ŒConcurrentMapCacheManager</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Configuration(proxyBeanMethods = false)</span><br><span class="line">@ConditionalOnMissingBean(CacheManager.class)</span><br><span class="line">@Conditional(CacheCondition.class)</span><br><span class="line">class SimpleCacheConfiguration &#123;</span><br><span class="line"></span><br><span class="line">	@Bean</span><br><span class="line">	ConcurrentMapCacheManager cacheManager(CacheProperties cacheProperties,</span><br><span class="line">			CacheManagerCustomizers cacheManagerCustomizers) &#123;</span><br><span class="line">		ConcurrentMapCacheManager cacheManager = new ConcurrentMapCacheManager();</span><br><span class="line">		List&lt;String&gt; cacheNames = cacheProperties.getCacheNames();</span><br><span class="line">		if (!cacheNames.isEmpty()) &#123;</span><br><span class="line">			cacheManager.setCacheNames(cacheNames);</span><br><span class="line">		&#125;</span><br><span class="line">		return cacheManagerCustomizers.customize(cacheManager);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>ConcurrentMapCacheManagerå¯ä»¥è·å–å’Œç¼“å­˜ConcurrentMapCacheçš„ç¼“å­˜ç»„ä»¶ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentMapCacheManager</span> <span class="keyword">implements</span> <span class="title">CacheManager</span>, <span class="title">BeanClassLoaderAware</span> </span>&#123;</span><br><span class="line"><span class="comment">//é‚£ä¹ˆç¨‹åºä¼šå…ˆæŠŠè¿™ä¸ªcacheåŠ è½½å‡ºæ¥ï¼š</span></span><br><span class="line"><span class="comment">//ï¼ˆ1.ï¼‰åˆ¤æ–­è¿™ä¸ªcacheæ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="comment">//ï¼ˆ2.ï¼‰å¦‚æœä¸å­˜åœ¨å°±åŠ é”å†æ¬¡ç¡®è®¤ä¸€é</span></span><br><span class="line"><span class="comment">//ï¼ˆ3.ï¼‰è¿˜æ˜¯ä¸å­˜åœ¨å°±åˆ›å»ºConcurrentMapCacheç±»å‹çš„cacheï¼Œå¹¶putåˆ°concurrentMapä¸­</span></span><br><span class="line">    <span class="comment">//ç¼“å­˜ç»„ä»¶æ²¡æœ‰å°±åˆ›å»º</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		Cache cache = <span class="keyword">this</span>.cacheMap.get(name);</span><br><span class="line">		<span class="keyword">if</span> (cache == <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.dynamic) &#123;</span><br><span class="line">			<span class="keyword">synchronized</span> (<span class="keyword">this</span>.cacheMap) &#123;</span><br><span class="line">				cache = <span class="keyword">this</span>.cacheMap.get(name);</span><br><span class="line">				<span class="keyword">if</span> (cache == <span class="keyword">null</span>) &#123;</span><br><span class="line">					cache = createConcurrentMapCache(name);</span><br><span class="line">					<span class="keyword">this</span>.cacheMap.put(name, cache);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> cache;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆ›å»ºç¼“å­˜ç»„ä»¶</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Cache <span class="title">createConcurrentMapCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		SerializationDelegate actualSerialization = (isStoreByValue() ? <span class="keyword">this</span>.serialization : <span class="keyword">null</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ConcurrentMapCache(name, <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>),</span><br><span class="line">				isAllowNullValues(), actualSerialization);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>ConcurrentMapCacheï¼ŒConcurrentMapCacheå†…éƒ¨ä½¿ç”¨ConcurrentHashMapç¼“å­˜æ•°æ®ï¼ŒConcurrentHashMapæ˜¯çº¿ç¨‹å®‰å…¨çš„Mapç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">get</span><span class="params">(Object key, Callable&lt;T&gt; valueLoader)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (T) fromStoreValue(<span class="keyword">this</span>.store.computeIfAbsent(key, k -&gt; &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> toStoreValue(valueLoader.call());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ValueRetrievalException(key, valueLoader, ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;));</span><br><span class="line">&#125;</span><br><span class="line">   </span><br></pre></td></tr></table></figure></li>
<li><p>CacheAspectSupportç¼“å­˜æ‰§è¡Œæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. è·å–ç¼“å­˜ç»„ä»¶</span></span><br><span class="line"><span class="comment">//2.æŸ¥çœ‹æ˜¯å¦æœ‰ç¼“å­˜å‡»ä¸­ï¼Œæœ‰åˆ™è¿”å›ï¼Œå¦åˆ™æ‰§è¡Œæ–¹æ³•ï¼Œè·å–éœ€è¦ç¼“å­˜çš„å€¼å¹¶æ”¾å…¥ç¼“å­˜</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> Object <span class="title">execute</span><span class="params">(<span class="keyword">final</span> CacheOperationInvoker invoker, Method method, CacheOperationContexts contexts)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Special handling of synchronized invocation</span></span><br><span class="line">		<span class="keyword">if</span> (contexts.isSynchronized()) &#123;</span><br><span class="line">			CacheOperationContext context = contexts.get(CacheableOperation.class).iterator().next();</span><br><span class="line">			<span class="keyword">if</span> (isConditionPassing(context, CacheOperationExpressionEvaluator.NO_RESULT)) &#123;</span><br><span class="line">                <span class="comment">//keyç”Ÿæˆç­–ç•¥</span></span><br><span class="line">				Object key = generateKey(context, CacheOperationExpressionEvaluator.NO_RESULT);</span><br><span class="line">				Cache cache = context.getCaches().iterator().next();</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> wrapCacheValue(method, cache.get(key, () -&gt; unwrapReturnValue(invokeOperation(invoker))));</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (Cache.ValueRetrievalException ex) &#123;</span><br><span class="line">					<span class="comment">// The invoker wraps any Throwable in a ThrowableWrapper instance so we</span></span><br><span class="line">					<span class="comment">// can just make sure that one bubbles up the stack.</span></span><br><span class="line">					<span class="keyword">throw</span> (CacheOperationInvoker.ThrowableWrapper) ex.getCause();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// No caching required, only call the underlying method</span></span><br><span class="line">				<span class="keyword">return</span> invokeOperation(invoker);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Process any early evictions</span></span><br><span class="line">		processCacheEvicts(contexts.get(CacheEvictOperation.class), <span class="keyword">true</span>,</span><br><span class="line">				CacheOperationExpressionEvaluator.NO_RESULT);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Check if we have a cached item matching the conditions</span></span><br><span class="line">		Cache.ValueWrapper cacheHit = findCachedItem(contexts.get(CacheableOperation.class));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Collect puts from any @Cacheable miss, if no cached item is found</span></span><br><span class="line">		List&lt;CachePutRequest&gt; cachePutRequests = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">		<span class="keyword">if</span> (cacheHit == <span class="keyword">null</span>) &#123;</span><br><span class="line">			collectPutRequests(contexts.get(CacheableOperation.class),</span><br><span class="line">					CacheOperationExpressionEvaluator.NO_RESULT, cachePutRequests);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Object cacheValue;</span><br><span class="line">		Object returnValue;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (cacheHit != <span class="keyword">null</span> &amp;&amp; !hasCachePut(contexts)) &#123;</span><br><span class="line">			<span class="comment">// If there are no put requests, just use the cache hit</span></span><br><span class="line">			cacheValue = cacheHit.get();</span><br><span class="line">			returnValue = wrapCacheValue(method, cacheValue);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Invoke the method if we don&#x27;t have a cache hit</span></span><br><span class="line">			returnValue = invokeOperation(invoker);</span><br><span class="line">			cacheValue = unwrapReturnValue(returnValue);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Collect any explicit @CachePuts</span></span><br><span class="line">        <span class="comment">//ç»“æœæ”¾å…¥ç¼“å­˜</span></span><br><span class="line">		collectPutRequests(contexts.get(CachePutOperation.class), cacheValue, cachePutRequests);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Process any collected put requests, either from @CachePut or a @Cacheable miss</span></span><br><span class="line">		<span class="keyword">for</span> (CachePutRequest cachePutRequest : cachePutRequests) &#123;</span><br><span class="line">			cachePutRequest.apply(cacheValue);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Process any late evictions</span></span><br><span class="line">		processCacheEvicts(contexts.get(CacheEvictOperation.class), <span class="keyword">false</span>, cacheValue);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> returnValue;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="é›†æˆRedisç¼“å­˜ä¸­é—´ä»¶"><a href="#é›†æˆRedisç¼“å­˜ä¸­é—´ä»¶" class="headerlink" title="é›†æˆRedisç¼“å­˜ä¸­é—´ä»¶"></a>é›†æˆRedisç¼“å­˜ä¸­é—´ä»¶</h4><p>æŸ¥çœ‹é…ç½®ç±»<code>org.springframework.boot.autoconfigure.cache.RedisCacheConfiguration</code>,å‘ç°åªè¦å¼•å…¥redisçš„starterå°±å¯ä»¥ä½¿ç”¨è¯¥é…ç½®ï¼Œå¦‚æœè¿˜æœ‰å…¶ä»–ç¼“å­˜ä¸­é—´ä»¶ï¼Œé…ç½®æŒ‡å®š<code>spring.cache.type=redis</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(RedisConnectionFactory.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(RedisAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(RedisConnectionFactory.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(CacheManager.class)</span></span><br><span class="line"><span class="meta">@Conditional(CacheCondition.class)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisCacheConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function">RedisCacheManager <span class="title">cacheManager</span><span class="params">(CacheProperties cacheProperties, CacheManagerCustomizers cacheManagerCustomizers,</span></span></span><br><span class="line"><span class="params"><span class="function">			ObjectProvider&lt;org.springframework.data.redis.cache.RedisCacheConfiguration&gt; redisCacheConfiguration,</span></span></span><br><span class="line"><span class="params"><span class="function">			ObjectProvider&lt;RedisCacheManagerBuilderCustomizer&gt; redisCacheManagerBuilderCustomizers,</span></span></span><br><span class="line"><span class="params"><span class="function">			RedisConnectionFactory redisConnectionFactory, ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">		RedisCacheManagerBuilder builder = RedisCacheManager.builder(redisConnectionFactory).cacheDefaults(</span><br><span class="line">				determineConfiguration(cacheProperties, redisCacheConfiguration, resourceLoader.getClassLoader()));</span><br><span class="line">		List&lt;String&gt; cacheNames = cacheProperties.getCacheNames();</span><br><span class="line">		<span class="keyword">if</span> (!cacheNames.isEmpty()) &#123;</span><br><span class="line">			builder.initialCacheNames(<span class="keyword">new</span> LinkedHashSet&lt;&gt;(cacheNames));</span><br><span class="line">		&#125;</span><br><span class="line">		redisCacheManagerBuilderCustomizers.orderedStream().forEach((customizer) -&gt; customizer.customize(builder));</span><br><span class="line">		<span class="keyword">return</span> cacheManagerCustomizers.customize(builder.build());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> org.springframework.data.redis.cache.<span class="function">RedisCacheConfiguration <span class="title">determineConfiguration</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">			CacheProperties cacheProperties,</span></span></span><br><span class="line"><span class="params"><span class="function">			ObjectProvider&lt;org.springframework.data.redis.cache.RedisCacheConfiguration&gt; redisCacheConfiguration,</span></span></span><br><span class="line"><span class="params"><span class="function">			ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> redisCacheConfiguration.getIfAvailable(() -&gt; createConfiguration(cacheProperties, classLoader));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> org.springframework.data.redis.cache.<span class="function">RedisCacheConfiguration <span class="title">createConfiguration</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">			CacheProperties cacheProperties, ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">		Redis redisProperties = cacheProperties.getRedis();</span><br><span class="line">		org.springframework.data.redis.cache.RedisCacheConfiguration config = org.springframework.data.redis.cache.RedisCacheConfiguration</span><br><span class="line">				.defaultCacheConfig();</span><br><span class="line">		config = config.serializeValuesWith(</span><br><span class="line">				SerializationPair.fromSerializer(<span class="keyword">new</span> JdkSerializationRedisSerializer(classLoader)));</span><br><span class="line">		<span class="keyword">if</span> (redisProperties.getTimeToLive() != <span class="keyword">null</span>) &#123;</span><br><span class="line">			config = config.entryTtl(redisProperties.getTimeToLive());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (redisProperties.getKeyPrefix() != <span class="keyword">null</span>) &#123;</span><br><span class="line">			config = config.prefixKeysWith(redisProperties.getKeyPrefix());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!redisProperties.isCacheNullValues()) &#123;</span><br><span class="line">			config = config.disableCachingNullValues();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!redisProperties.isUseKeyPrefix()) &#123;</span><br><span class="line">			config = config.disableKeyPrefix();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> config;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤æƒ…å†µä¸‹redisä¼šè¿æ¥<code>localhost:6379</code>,ç›´æ¥è¿è¡Œå³å¯</p>
<h4 id="å…±äº«-Session"><a href="#å…±äº«-Session" class="headerlink" title="å…±äº« Session"></a>å…±äº« Session</h4><p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒSession å…±äº«æœ‰å¾ˆå¤šçš„è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­æ‰˜ç®¡åˆ°ç¼“å­˜ä¸­åº”è¯¥æ˜¯æœ€å¸¸ç”¨çš„æ–¹æ¡ˆä¹‹ä¸€ï¼Œ</p>
<p>Spring Session provides an API and implementations for managing a userâ€™s session information.</p>
<p>Spring Session æä¾›äº†ä¸€å¥—åˆ›å»ºå’Œç®¡ç† Servlet HttpSession çš„æ–¹æ¡ˆã€‚Spring Session æä¾›äº†é›†ç¾¤ Sessionï¼ˆClustered Sessionsï¼‰åŠŸèƒ½ï¼Œé»˜è®¤é‡‡ç”¨å¤–ç½®çš„ Redis æ¥å­˜å‚¨ Session æ•°æ®ï¼Œä»¥æ­¤æ¥è§£å†³ Session å…±äº«çš„é—®é¢˜ã€‚</p>
<ol>
<li><p>å¼•å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>Session é…ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 86400*30)</span><br><span class="line">public class SessionConfig &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>maxInactiveIntervalInSeconds: è®¾ç½® Session å¤±æ•ˆæ—¶é—´ï¼Œä½¿ç”¨ Redis Session ä¹‹åï¼ŒåŸ Spring Boot çš„ server.session.timeout å±æ€§ä¸å†ç”Ÿæ•ˆã€‚</p>
</blockquote>
</li>
<li><p>æµ‹è¯•</p>
<p>æ·»åŠ æµ‹è¯•æ–¹æ³•è·å– sessionid</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(&quot;/uid&quot;)</span><br><span class="line">String uid(HttpSession session) &#123;</span><br><span class="line">    UUID uid = (UUID) session.getAttribute(&quot;uid&quot;);</span><br><span class="line">    if (uid == null) &#123;</span><br><span class="line">        uid = UUID.randomUUID();</span><br><span class="line">    &#125;</span><br><span class="line">    session.setAttribute(&quot;uid&quot;, uid);</span><br><span class="line">    return session.getId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç™»å½• Redis è¾“å…¥ <code>keys &#39;*sessions*&#39;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">t&lt;spring:session:sessions:db031986-8ecc-48d6-b471-b137a3ed6bc4</span><br><span class="line">t(spring:session:expirations:1472976480000</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ 1472976480000 ä¸ºå¤±æ•ˆæ—¶é—´ï¼Œæ„æ€æ˜¯è¿™ä¸ªæ—¶é—´å Session å¤±æ•ˆï¼Œ<code>db031986-8ecc-48d6-b471-b137a3ed6bc4</code> ä¸º sessionId,ç™»å½• <a target="_blank" rel="noopener" href="http://localhost:8080/uid">http://localhost:8080/uid</a> å‘ç°ä¼šä¸€è‡´ï¼Œå°±è¯´æ˜ Session å·²ç»åœ¨ Redis é‡Œé¢è¿›è¡Œæœ‰æ•ˆçš„ç®¡ç†äº†ã€‚</p>
</li>
<li><p>å¦‚ä½•åœ¨ä¸¤å°æˆ–è€…å¤šå°ä¸­å…±äº« Session</p>
<p>å…¶å®å°±æ˜¯æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤åœ¨å¦ä¸€ä¸ªé¡¹ç›®ä¸­å†æ¬¡é…ç½®ä¸€æ¬¡ï¼Œå¯åŠ¨åè‡ªåŠ¨å°±è¿›è¡Œäº† Session å…±äº«ã€‚</p>
</li>
</ol>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ol>
<li><a target="_blank" rel="noopener" href="https://blog.51cto.com/zhibeiwang/1965018">è´Ÿè½½å‡è¡¡é›†ç¾¤ä¸­çš„sessionè§£å†³æ–¹æ¡ˆ</a></li>
<li><a target="_blank" rel="noopener" href="http://emacoo.cn/blog/spring-redis">Redisçš„ä¸¤ä¸ªå…¸å‹åº”ç”¨åœºæ™¯</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000004358410">SpringBootåº”ç”¨ä¹‹åˆ†å¸ƒå¼ä¼šè¯</a></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">å¹³å¿ƒ</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://pingxin0521.gitee.io/2019/06/30/Java-SpringBoot-1-4-1/">https://pingxin0521.gitee.io/2019/06/30/Java-SpringBoot-1-4-1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://pingxin0521.gitee.io" target="_blank">å¹³å¿ƒdeå°å±‹</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/%E6%A1%86%E6%9E%B6/">æ¡†æ¶</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/07/01/node-2-2/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">Node.JS å†æ·±å…¥ -- http</div></div></a></div><div class="next-post pull-right"><a href="/2019/06/30/Java-SpringBoot-1-4-0/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Spring boot æ•°æ®è®¿é—®</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2019/07/12/Java-SpringBoot-1-4-2/" title="Spring boot æ•°æ®è®¿é—® MongoDB"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/okfOw28KlZFbE7z.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-01-25</div><div class="title">Spring boot æ•°æ®è®¿é—® MongoDB</div></div></a></div><div><a href="/2019/12/10/Java-SpringBoot-1-6-1/" title="Spring boot æ¶ˆæ¯é˜Ÿåˆ—(ä½¿ç”¨RabbitMQ)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-02-09</div><div class="title">Spring boot æ¶ˆæ¯é˜Ÿåˆ—(ä½¿ç”¨RabbitMQ)</div></div></a></div><div><a href="/2019/05/30/Java-SpringCloud-0-0/" title="Spring Cloud å…¥é—¨ (ä¸€)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/7dHvepmfYOLWTrX.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-12-27</div><div class="title">Spring Cloud å…¥é—¨ (ä¸€)</div></div></a></div><div><a href="/2019/11/01/Java-SpringCloud-3-0/" title="Spring Cloud ç»„ä»¶ä¹‹Hystrix (äº”)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-12-27</div><div class="title">Spring Cloud ç»„ä»¶ä¹‹Hystrix (äº”)</div></div></a></div><div><a href="/2019/10/27/Java-SpringCloud-6-0/" title="å¾®æœåŠ¡ç»„ä»¶--åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/PFDRNxj93taz6pw.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-12-27</div><div class="title">å¾®æœåŠ¡ç»„ä»¶--åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ</div></div></a></div><div><a href="/2019/11/03/Java-SpringCloud-6-2/" title="SpringCloudç»„ä»¶ä¹‹Spring Cloud Sleuth (å…«)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2020-12-27</div><div class="title">SpringCloudç»„ä»¶ä¹‹Spring Cloud Sleuth (å…«)</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://s2.ax1x.com/2020/02/11/1ovw6J.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">å¹³å¿ƒ</div><div class="author-info__description">å¹´è½»äººçš„lifeã€learn and think</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">449</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">77</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">68</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/hanyunpeng0521"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/hanyunpeng0521" target="_blank" title="Github"><i class="fa fa-github"></i></a><a class="social-icon" href="mailto:m13839441583@163.com" target="_blank" title="Email"><i class="fa fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title=""><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>å…¬å‘Š</span></div><div class="announcement_content">ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå¼€å§‹æé—®å§</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.</span> <span class="toc-text">ç¤ºä¾‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">è‡ªåŠ¨é…ç½®</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-number"></span> <span class="toc-text">ç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JSR107"><span class="toc-number">1.</span> <span class="toc-text">JSR107</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring%E7%BC%93%E5%AD%98%E6%8A%BD%E8%B1%A1"><span class="toc-number">2.</span> <span class="toc-text">Springç¼“å­˜æŠ½è±¡</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5-amp-%E7%BC%93%E5%AD%98%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.1.</span> <span class="toc-text">å‡ ä¸ªé‡è¦æ¦‚å¿µ&amp;ç¼“å­˜æ³¨è§£</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">3.</span> <span class="toc-text">ç¤ºä¾‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">ç¼“å­˜åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%86%E6%88%90Redis%E7%BC%93%E5%AD%98%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">é›†æˆRedisç¼“å­˜ä¸­é—´ä»¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB-Session"><span class="toc-number">6.</span> <span class="toc-text">å…±äº« Session</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">7.</span> <span class="toc-text">å‚è€ƒ</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2021/05/15/node-2-4/" title="Egg.js -- ä¸ºä¼ä¸šçº§æ¡†æ¶å’Œåº”ç”¨è€Œç”Ÿ"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/okfOw28KlZFbE7z.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Egg.js -- ä¸ºä¼ä¸šçº§æ¡†æ¶å’Œåº”ç”¨è€Œç”Ÿ"/></a><div class="content"><a class="title" href="/2021/05/15/node-2-4/" title="Egg.js -- ä¸ºä¼ä¸šçº§æ¡†æ¶å’Œåº”ç”¨è€Œç”Ÿ">Egg.js -- ä¸ºä¼ä¸šçº§æ¡†æ¶å’Œåº”ç”¨è€Œç”Ÿ</a><time datetime="2021-05-15T10:18:59.000Z" title="å‘è¡¨äº 2021-05-15 18:18:59">2021-05-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/30/node-2-3/" title="Koa -- åŸºäºNode.jså¹³å°çš„ä¸‹ä¸€ä»£Webå¼€å‘æ¡†æ¶"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/HjVAdIuT7bZJypS.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Koa -- åŸºäºNode.jså¹³å°çš„ä¸‹ä¸€ä»£Webå¼€å‘æ¡†æ¶"/></a><div class="content"><a class="title" href="/2021/04/30/node-2-3/" title="Koa -- åŸºäºNode.jså¹³å°çš„ä¸‹ä¸€ä»£Webå¼€å‘æ¡†æ¶">Koa -- åŸºäºNode.jså¹³å°çš„ä¸‹ä¸€ä»£Webå¼€å‘æ¡†æ¶</a><time datetime="2021-04-30T10:18:59.000Z" title="å‘è¡¨äº 2021-04-30 18:18:59">2021-04-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/01/node-2-1/" title="Node.JS webå¼€å‘å‰ç½®çŸ¥è¯†"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Node.JS webå¼€å‘å‰ç½®çŸ¥è¯†"/></a><div class="content"><a class="title" href="/2021/04/01/node-2-1/" title="Node.JS webå¼€å‘å‰ç½®çŸ¥è¯†">Node.JS webå¼€å‘å‰ç½®çŸ¥è¯†</a><time datetime="2021-04-01T03:18:59.000Z" title="å‘è¡¨äº 2021-04-01 11:18:59">2021-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-1/" title="ç¬¬åä¸€å‘¨--è°·æ­Œæµè§ˆå™¨æ’ä»¶"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/gGE57HRvpcKPfDY.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ç¬¬åä¸€å‘¨--è°·æ­Œæµè§ˆå™¨æ’ä»¶"/></a><div class="content"><a class="title" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-1/" title="ç¬¬åä¸€å‘¨--è°·æ­Œæµè§ˆå™¨æ’ä»¶">ç¬¬åä¸€å‘¨--è°·æ­Œæµè§ˆå™¨æ’ä»¶</a><time datetime="2020-12-26T10:18:59.000Z" title="å‘è¡¨äº 2020-12-26 18:18:59">2020-12-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-0/" title="ç¬¬åä¸€å‘¨--æµè§ˆå™¨æŠ€æœ¯"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2020/05/08/vCnKyoFJZ1g4XYR.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ç¬¬åä¸€å‘¨--æµè§ˆå™¨æŠ€æœ¯"/></a><div class="content"><a class="title" href="/2020/12/26/%E5%91%A8%E8%AE%B0-10-0/" title="ç¬¬åä¸€å‘¨--æµè§ˆå™¨æŠ€æœ¯">ç¬¬åä¸€å‘¨--æµè§ˆå™¨æŠ€æœ¯</a><time datetime="2020-12-26T06:18:59.000Z" title="å‘è¡¨äº 2020-12-26 14:18:59">2020-12-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2021 By å¹³å¿ƒ</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '4lfIXzqxaC1ONs0MJO4oHu07-gzGzoHsz',
      appKey: 'qw99Bw8FD0KVKU9m457CwWsr',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: true,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: true,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>